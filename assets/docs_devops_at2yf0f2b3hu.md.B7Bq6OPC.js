import{_ as n,a,o as l,a3 as p}from"./chunks/framework.dRMRuUHH.js";const F=JSON.parse('{"title":"jenkins构建CI/CD环境","description":"","frontmatter":{"id":6,"title":"jenkins构建CI/CD环境","createTime":"2024-04-27 12:01:01","category":"devops"},"headers":[],"relativePath":"docs/devops/at2yf0f2b3hu.md","filePath":"docs/devops/00401_jenkins_pipeline.md"}'),e={name:"docs/devops/at2yf0f2b3hu.md"};function o(r,s,c,t,i,b){return l(),a("div",null,[...s[0]||(s[0]=[p(`<h2 id="快速部署gitlab和jenkins" tabindex="-1">快速部署gitlab和jenkins <a class="header-anchor" href="#快速部署gitlab和jenkins" aria-label="Permalink to “快速部署gitlab和jenkins”">​</a></h2><div class="tip custom-block"><p class="custom-block-title custom-block-title-default">TIP</p><p>该示例采用<code>docker-compose</code>部署<code>gitlab</code>和<code>jenkins</code>；其中<code>jenkins</code>开启了特权模式，挂载了<code>docker.sock</code>文件用于和宿主机的<code>docker</code>进程通信</p></div><p><code>docker-compose.yaml</code>文件内容</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2;" tabindex="0" dir="ltr"><code><span class="line"><span style="color:#F92672;">version</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&#39;3&#39;</span></span>
<span class="line"><span style="color:#F92672;">services</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">  gitlab</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">    container_name</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">gitlab</span></span>
<span class="line"><span style="color:#F92672;">    hostname</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">gitlab</span></span>
<span class="line"><span style="color:#88846F;">    # 版本更新: https://docs.gitlab.com/ee/update/index.html#upgrade-paths </span></span>
<span class="line"><span style="color:#88846F;">    # 版本下载: https://packages.gitlab.com/app/gitlab/gitlab-ce/search</span></span>
<span class="line"><span style="color:#88846F;">    # image: gitlab/gitlab-ce:latest</span></span>
<span class="line"><span style="color:#F92672;">    image</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">gitlab/gitlab-ce:14.6.1-ce.0</span></span>
<span class="line"><span style="color:#F92672;">    restart</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">unless-stopped</span></span>
<span class="line"><span style="color:#F92672;">    environment</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">      TZ</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&#39;Asia/Shanghai&#39;</span></span>
<span class="line"><span style="color:#F92672;">      EXTERNAL_URL</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&#39;http://192.168.10.11:8000&#39;</span></span>
<span class="line"><span style="color:#F92672;">      GITLAB_OMNIBUS_CONFIG</span><span style="color:#F8F8F2;">: </span><span style="color:#F92672;">|</span></span>
<span class="line"><span style="color:#E6DB74;">        external_url &#39;http://192.168.10.11:8000&#39;</span></span>
<span class="line"><span style="color:#E6DB74;">        gitlab_rails[&#39;initial_root_password&#39;] = &#39;testfind&#39;</span></span>
<span class="line"><span style="color:#F92672;">    ports</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">&quot;8000:8000&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">&quot;8022:22&quot;</span></span>
<span class="line"><span style="color:#F92672;">    volumes</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">./gitlab/config:/etc/gitlab</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">./gitlab/data:/var/opt/gitlab</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">./gitlab/logs:/var/log/gitlab</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">/etc/localtime:/etc/localtime</span></span>
<span class="line"><span style="color:#F92672;">    logging</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">      driver</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">json-file</span></span>
<span class="line"><span style="color:#F92672;">      options</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">        max-size</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">100m</span></span>
<span class="line"><span style="color:#F92672;">        max-file</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&quot;3&quot;</span></span>
<span class="line"><span style="color:#F92672;">    networks</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">devops</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672;">  jenkins</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">    container_name</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">jenkins</span></span>
<span class="line"><span style="color:#F92672;">    hostname</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">jenkins</span></span>
<span class="line"><span style="color:#88846F;">    # image: jenkins/jenkins:lts</span></span>
<span class="line"><span style="color:#F92672;">    image</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">jenkins/jenkins:2.453</span></span>
<span class="line"><span style="color:#F92672;">    restart</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">unless-stopped</span></span>
<span class="line highlighted"><span style="color:#F92672;">    privileged</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">true</span></span>
<span class="line"><span style="color:#F92672;">    user</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">root</span></span>
<span class="line"><span style="color:#F92672;">    environment</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">      TZ</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&#39;Asia/Shanghai&#39;</span></span>
<span class="line"><span style="color:#F92672;">      JAVA_OPTS</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&#39;-Duser.timezone=Asia/Shanghai&#39;</span></span>
<span class="line"><span style="color:#F92672;">    ports</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">&quot;8080:8080&quot;</span></span>
<span class="line"><span style="color:#F92672;">    volumes</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">./jenkins/data:/var/jenkins_home</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">./jenkins/docker:/root/.docker</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">/var/run/docker.sock:/var/run/docker.sock</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">/usr/bin/docker:/usr/bin/docker</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">/etc/localtime:/etc/localtime</span></span>
<span class="line"><span style="color:#F92672;">    logging</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">      driver</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">json-file</span></span>
<span class="line"><span style="color:#F92672;">      options</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">        max-size</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">100m</span></span>
<span class="line"><span style="color:#F92672;">        max-file</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&quot;3&quot;</span></span>
<span class="line"><span style="color:#F92672;">    networks</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">devops</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672;">networks</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">  devops</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">    driver</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">bridge</span></span>
<span class="line"><span style="color:#F92672;">    ipam</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">      config</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">        - </span><span style="color:#F92672;">subnet</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">172.80.0.0/16</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><h2 id="jenkins配置" tabindex="-1">jenkins配置 <a class="header-anchor" href="#jenkins配置" aria-label="Permalink to “jenkins配置”">​</a></h2><div class="tip custom-block"><p class="custom-block-title custom-block-title-default">TIP</p><p><code>jenkins</code>初始密码可以通过日志或者<code>/var/jenkins_home/secrets/initialAdminPassword</code>文件查看</p></div><h3 id="更新插件地址" tabindex="-1">更新插件地址 <a class="header-anchor" href="#更新插件地址" aria-label="Permalink to “更新插件地址”">​</a></h3><p>进入jenkins容器中执行</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2;" tabindex="0" dir="ltr"><code><span class="line"><span style="color:#A6E22E;">sed</span><span style="color:#AE81FF;"> -i</span><span style="color:#E6DB74;"> &#39;s#updates.jenkins.io/download/plugins#mirrors.tuna.tsinghua.edu.cn/jenkins/plugins#g&#39;</span><span style="color:#E6DB74;"> /var/jenkins_home/updates/default.json</span></span>
<span class="line"><span style="color:#A6E22E;">sed</span><span style="color:#AE81FF;"> -i</span><span style="color:#E6DB74;"> &#39;s#www.google.com#www.baidu.com#g&#39;</span><span style="color:#E6DB74;"> /var/jenkins_home/updates/default.json</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>或者在当前目录下执行</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2;" tabindex="0" dir="ltr"><code><span class="line"><span style="color:#A6E22E;">sed</span><span style="color:#AE81FF;"> -i</span><span style="color:#E6DB74;"> &#39;s#updates.jenkins.io/download/plugins#mirrors.tuna.tsinghua.edu.cn/jenkins/plugins#g&#39;</span><span style="color:#E6DB74;"> jenkins/data/updates/default.json</span></span>
<span class="line"><span style="color:#A6E22E;">sed</span><span style="color:#AE81FF;"> -i</span><span style="color:#E6DB74;"> &#39;s#www.google.com#www.baidu.com#g&#39;</span><span style="color:#E6DB74;"> jenkins/data/updates/default.json</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="下载插件" tabindex="-1">下载插件 <a class="header-anchor" href="#下载插件" aria-label="Permalink to “下载插件”">​</a></h3><ul><li><code>Localization: Chinese (Simplified)</code></li><li><code>Pipeline</code></li><li><code>Pipeline: GitHub Groovy Libraries</code></li><li><code>Pipeline: Stage View Plugin</code></li><li><code>Git</code></li><li><code>Git Parameter</code></li><li><code>Workspace Cleanup</code></li><li><code>SSH Agent</code></li><li><code>SSH Build Agents</code></li><li><code>Publish Over SSH</code></li></ul><h3 id="全局工具配置" tabindex="-1">全局工具配置 <a class="header-anchor" href="#全局工具配置" aria-label="Permalink to “全局工具配置”">​</a></h3><ul><li><code>JDK</code>安装: 指定<code>jdk</code>安装路径，指定别名<code>jdk8</code>供<code>pipeline</code>使用</li><li><code>Maven</code>安装: 指定<code>maven</code>安装路径，指定别名<code>mvn3</code>供<code>pipeline</code>使用，并配置<code>settings.xml</code></li></ul><h3 id="凭据管理" tabindex="-1">凭据管理 <a class="header-anchor" href="#凭据管理" aria-label="Permalink to “凭据管理”">​</a></h3><ul><li><code>git-user-pass</code>: git仓库登录凭证</li><li><code>harbor-user-pass</code>: harbor仓库登录凭证，或者执行之前手动登录一次镜像仓库</li></ul><h3 id="创建任务" tabindex="-1">创建任务 <a class="header-anchor" href="#创建任务" aria-label="Permalink to “创建任务”">​</a></h3><p>添加参数: 参数化构建过程 -&gt; 选项参数 -&gt; <code>branchName</code></p><p>创建流水线脚本:</p><div class="tip custom-block"><p class="custom-block-title custom-block-title-default">TIP</p><p>⚡该<code>pipeline</code>模板只包括：清理工作空间、clone仓库、打包、构建镜像、推送镜像；请根据实际情况进行修改</p></div><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2;" tabindex="0" dir="ltr"><code><span class="line"><span style="color:#A6E22E;">pipeline</span><span style="color:#E6DB74;"> {</span></span>
<span class="line"><span style="color:#A6E22E;">    agent</span><span style="color:#E6DB74;"> any</span></span>
<span class="line"><span style="color:#A6E22E;">    environment</span><span style="color:#E6DB74;"> {</span></span>
<span class="line"><span style="color:#A6E22E;">        //</span><span style="color:#E6DB74;"> git仓库地址</span></span>
<span class="line"><span style="color:#A6E22E;">        gitUrl</span><span style="color:#E6DB74;"> =</span><span style="color:#E6DB74;"> &quot;http://192.168.10.11:8000/group01/demo-jenkins01.git&quot;</span></span>
<span class="line"><span style="color:#A6E22E;">        //</span><span style="color:#E6DB74;"> git仓库分支</span></span>
<span class="line"><span style="color:#A6E22E;">        branchName</span><span style="color:#E6DB74;"> =</span><span style="color:#E6DB74;"> &quot;\${</span><span style="color:#F8F8F2;">branchName</span><span style="color:#E6DB74;">}&quot;</span></span>
<span class="line"><span style="color:#A6E22E;">        //</span><span style="color:#E6DB74;"> 项目的相对路径</span></span>
<span class="line"><span style="color:#A6E22E;">        projPath</span><span style="color:#E6DB74;"> =</span><span style="color:#E6DB74;"> &quot;demo-hello&quot;</span></span>
<span class="line"><span style="color:#A6E22E;">        //</span><span style="color:#E6DB74;"> 镜像名称</span></span>
<span class="line"><span style="color:#A6E22E;">        imageName</span><span style="color:#E6DB74;"> =</span><span style="color:#E6DB74;"> &quot;demo-hello&quot;</span></span>
<span class="line"><span style="color:#A6E22E;">        //</span><span style="color:#E6DB74;"> 镜像tag</span></span>
<span class="line"><span style="color:#A6E22E;">        imageTag</span><span style="color:#E6DB74;"> =</span><span style="color:#E6DB74;"> sh</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">script:</span><span style="color:#E6DB74;"> &quot;echo \`</span><span style="color:#A6E22E;">date</span><span style="color:#E6DB74;"> +&#39;%Y%m%d_%H%M&#39;\`&quot;,</span><span style="color:#E6DB74;"> returnStdout:</span><span style="color:#AE81FF;"> true</span><span style="color:#F8F8F2;">)</span><span style="color:#E6DB74;">.trim</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#A6E22E;">        //</span><span style="color:#E6DB74;"> 镜像仓库地址</span></span>
<span class="line"><span style="color:#A6E22E;">        registryAddr</span><span style="color:#E6DB74;"> =</span><span style="color:#E6DB74;"> &quot;harbor.example.com&quot;</span></span>
<span class="line"><span style="color:#A6E22E;">        //</span><span style="color:#E6DB74;"> 镜像仓库名称</span></span>
<span class="line"><span style="color:#A6E22E;">        registryName</span><span style="color:#E6DB74;"> =</span><span style="color:#E6DB74;"> &quot;common-test&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#A6E22E;">    tools</span><span style="color:#E6DB74;"> {</span></span>
<span class="line"><span style="color:#A6E22E;">        //</span><span style="color:#E6DB74;"> 需要先在全局工具配置中配置jdk和maven</span></span>
<span class="line"><span style="color:#A6E22E;">        jdk</span><span style="color:#E6DB74;"> &#39;jdk8&#39;</span></span>
<span class="line"><span style="color:#A6E22E;">        maven</span><span style="color:#E6DB74;"> &#39;mvn3&#39;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#A6E22E;">    stages</span><span style="color:#E6DB74;"> {</span></span>
<span class="line"><span style="color:#A6E22E;">        stage(</span><span style="color:#A6E22E;">&#39;清理工作空间&#39;</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#A6E22E;">            steps</span><span style="color:#E6DB74;"> {</span></span>
<span class="line"><span style="color:#66D9EF;">                echo</span><span style="color:#E6DB74;"> &#39;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 开始清理工作空间&#39;</span></span>
<span class="line"><span style="color:#A6E22E;">                cleanWs</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">            }</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#A6E22E;">        stage(</span><span style="color:#A6E22E;">&#39;拉取代码&#39;</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#A6E22E;">            steps</span><span style="color:#E6DB74;"> {</span></span>
<span class="line"><span style="color:#66D9EF;">                echo</span><span style="color:#E6DB74;"> &#39;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 开始拉取代码&#39;</span></span>
<span class="line"><span style="color:#A6E22E;">                git</span><span style="color:#E6DB74;"> branch:</span><span style="color:#E6DB74;"> &quot;\${</span><span style="color:#F8F8F2;">branchName</span><span style="color:#E6DB74;">}&quot;,</span><span style="color:#E6DB74;"> credentialsId:</span><span style="color:#E6DB74;"> &#39;git-user-pass&#39;,</span><span style="color:#E6DB74;"> url:</span><span style="color:#E6DB74;"> &quot;\${</span><span style="color:#F8F8F2;">gitUrl</span><span style="color:#E6DB74;">}&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">            }</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#A6E22E;">        stage(</span><span style="color:#A6E22E;">&#39;mvn打包&#39;</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#A6E22E;">            steps</span><span style="color:#E6DB74;"> {</span></span>
<span class="line"><span style="color:#66D9EF;">                echo</span><span style="color:#E6DB74;"> &#39;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 开始mvn打包&#39;</span></span>
<span class="line"><span style="color:#A6E22E;">                sh</span><span style="color:#E6DB74;"> &#39;cd \${projPath} &amp;&amp; mvn -Dmaven.test.skip=true clean package&#39;</span></span>
<span class="line"><span style="color:#F8F8F2;">            }</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#A6E22E;">        stage(</span><span style="color:#A6E22E;">&#39;构建镜像&#39;</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#A6E22E;">            steps</span><span style="color:#E6DB74;"> {</span></span>
<span class="line"><span style="color:#66D9EF;">                echo</span><span style="color:#E6DB74;"> &#39;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 开始构建镜像&#39;</span></span>
<span class="line"><span style="color:#A6E22E;">                sh</span><span style="color:#E6DB74;"> &#39;cd \${projPath} &amp;&amp; docker build -t \${registryAddr}/\${registryName}/\${imageName}:\${imageTag} .&#39;</span></span>
<span class="line"><span style="color:#F8F8F2;">            }</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#A6E22E;">        stage(</span><span style="color:#A6E22E;">&#39;推送镜像&#39;</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#A6E22E;">            steps</span><span style="color:#E6DB74;"> {</span></span>
<span class="line"><span style="color:#A6E22E;">                //</span><span style="color:#E6DB74;"> 需要先创建凭证,或者使用.docker/config.json都可以</span></span>
<span class="line"><span style="color:#A6E22E;">                withCredentials([usernamePassword(credentialsId:</span><span style="color:#E6DB74;"> &quot;harbor-user-pass&quot;,</span><span style="color:#E6DB74;"> usernameVariable:</span><span style="color:#E6DB74;"> &#39;registryUser&#39;,</span><span style="color:#E6DB74;"> passwordVariable:</span><span style="color:#E6DB74;"> &#39;registryPass&#39;,</span><span style="color:#F8F8F2;">)]) {</span></span>
<span class="line"><span style="color:#66D9EF;">                    echo</span><span style="color:#E6DB74;"> &#39;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 登录镜像仓库&#39;</span></span>
<span class="line"><span style="color:#A6E22E;">                    sh</span><span style="color:#E6DB74;"> &quot;docker login -u \${</span><span style="color:#F8F8F2;">registryUser</span><span style="color:#E6DB74;">} -p \${</span><span style="color:#F8F8F2;">registryPass</span><span style="color:#E6DB74;">} \${</span><span style="color:#F8F8F2;">registryAddr</span><span style="color:#E6DB74;">}&quot;</span></span>
<span class="line"><span style="color:#66D9EF;">                    echo</span><span style="color:#E6DB74;"> &#39;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 开始推送镜像&#39;</span></span>
<span class="line"><span style="color:#A6E22E;">                    sh</span><span style="color:#E6DB74;"> &#39;docker push \${registryAddr}/\${registryName}/\${imageName}:\${imageTag}&#39;</span></span>
<span class="line"><span style="color:#F8F8F2;">                }</span></span>
<span class="line"><span style="color:#66D9EF;">                echo</span><span style="color:#E6DB74;"> &#39;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 清理本地镜像&#39;</span></span>
<span class="line"><span style="color:#A6E22E;">                sh</span><span style="color:#E6DB74;"> &#39;docker rmi \${registryAddr}/\${registryName}/\${imageName}:\${imageTag}&#39;</span></span>
<span class="line"><span style="color:#F8F8F2;">            }</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h2 id="gitlab配置" tabindex="-1">gitlab配置 <a class="header-anchor" href="#gitlab配置" aria-label="Permalink to “gitlab配置”">​</a></h2><div class="tip custom-block"><p class="custom-block-title custom-block-title-default">TIP</p><p><code>gitlab</code>初始密码可以通过添加配置<code>gitlab_rails[&#39;initial_root_password&#39;] = &quot;password&quot;</code>或者查看配置文件<code>cat /etc/gitlab/initial_root_password | grep -i password</code></p></div><p>⚡如果忘记管理员密码可以使用下面的方式重置密码</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2;" tabindex="0" dir="ltr"><code><span class="line"><span style="color:#88846F;"># 先行进入命令行控制台</span></span>
<span class="line"><span style="color:#A6E22E;">gitlab-rails</span><span style="color:#E6DB74;"> console</span><span style="color:#AE81FF;"> -e</span><span style="color:#E6DB74;"> production</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;"># 获取id为1的用户,即获取root用户</span></span>
<span class="line"><span style="color:#F8F8F2;">user</span><span style="color:#F92672;">=</span><span style="color:#E6DB74;">User.where</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">id:1</span><span style="color:#F8F8F2;">)</span><span style="color:#E6DB74;">.first</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;"># 查看和确认下用户名</span></span>
<span class="line"><span style="color:#A6E22E;">user.username</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;"># 修改密码,注意密码长度要大于8位</span></span>
<span class="line"><span style="color:#A6E22E;">user.password</span><span style="color:#E6DB74;">=</span><span style="color:#A6E22E;">&quot;xxxxxxxx&quot;</span></span>
<span class="line"><span style="color:#A6E22E;">user.password_confirmation</span><span style="color:#E6DB74;">=</span><span style="color:#A6E22E;">&quot;xxxxxxxx&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;"># 保存修改</span></span>
<span class="line"><span style="color:#A6E22E;">user.save!</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div>`,26)])])}const g=n(e,[["render",o]]);export{F as __pageData,g as default};
