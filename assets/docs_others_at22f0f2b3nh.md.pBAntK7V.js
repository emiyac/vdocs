import{_ as n,a,o as l,a3 as p}from"./chunks/framework.dRMRuUHH.js";const b=JSON.parse('{"title":"datax同步数据","description":"","frontmatter":{"id":3005,"title":"datax同步数据","createTime":"2024-03-14 17:10:20","category":"others"},"headers":[],"relativePath":"docs/others/at22f0f2b3nh.md","filePath":"docs/others/0005_datax.md"}'),e={name:"docs/others/at22f0f2b3nh.md"};function o(r,s,c,t,F,i){return l(),a("div",null,[...s[0]||(s[0]=[p(`<h2 id="测试环境" tabindex="-1">测试环境 <a class="header-anchor" href="#测试环境" aria-label="Permalink to “测试环境”">​</a></h2><p>可以使用<code>docker-compose</code>快速部署测试环境，下列示例测试将<code>mysql</code>中的数据同步至<code>postgresql</code>中</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2;" tabindex="0" dir="ltr"><code><span class="line"><span style="color:#F92672;">version</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&quot;3&quot;</span></span>
<span class="line"><span style="color:#F92672;">services</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">  mysql</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">    hostname</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">mysql</span></span>
<span class="line"><span style="color:#F92672;">    image</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">mysql:5.7.21</span></span>
<span class="line"><span style="color:#F92672;">    container_name</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">mysql</span></span>
<span class="line"><span style="color:#F92672;">    volumes</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">./data/mysql:/var/lib/mysql</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">/etc/localtime:/etc/localtime:ro</span></span>
<span class="line"><span style="color:#F92672;">    ports</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">&quot;13306:3306&quot;</span></span>
<span class="line"><span style="color:#F92672;">    environment</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">MYSQL_ROOT_PASSWORD=root</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">TZ=Asia/Shanghai</span></span>
<span class="line"><span style="color:#F92672;">    logging</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">      driver</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">json-file</span></span>
<span class="line"><span style="color:#F92672;">      options</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">        max-size</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">100m</span></span>
<span class="line"><span style="color:#F92672;">        max-file</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&quot;3&quot;</span></span>
<span class="line"><span style="color:#F92672;">    restart</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">on-failure</span></span>
<span class="line"><span style="color:#F92672;">    networks</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">datax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672;">  postgre</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">    hostname</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">postgre</span></span>
<span class="line"><span style="color:#F92672;">    image</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">bitnami/postgresql</span></span>
<span class="line"><span style="color:#F92672;">    container_name</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">postgre</span></span>
<span class="line"><span style="color:#F92672;">    volumes</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">./data/postgre:/bitnami/postgresql</span></span>
<span class="line"><span style="color:#F92672;">    ports</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">&quot;15432:5432&quot;</span></span>
<span class="line"><span style="color:#F92672;">    environment</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">POSTGRES_PASSWORD=testfind.12</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">POSTGRES_HOST_AUTH_METHOD=trust</span></span>
<span class="line"><span style="color:#F92672;">    logging</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">      driver</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">json-file</span></span>
<span class="line"><span style="color:#F92672;">      options</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">        max-size</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">100m</span></span>
<span class="line"><span style="color:#F92672;">        max-file</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&quot;3&quot;</span></span>
<span class="line"><span style="color:#F92672;">    restart</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">on-failure</span></span>
<span class="line"><span style="color:#F92672;">    networks</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">datax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672;">  datax</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">    hostname</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">datax</span></span>
<span class="line"><span style="color:#F92672;">    image</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">huas/datax</span></span>
<span class="line"><span style="color:#F92672;">    container_name</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">datax</span></span>
<span class="line"><span style="color:#F92672;">    volumes</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">/etc/localtime:/etc/localtime:ro</span></span>
<span class="line"><span style="color:#F92672;">    environment</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">TZ=Asia/Shanghai</span></span>
<span class="line"><span style="color:#F92672;">    command</span><span style="color:#F8F8F2;">: [</span><span style="color:#E6DB74;">&quot;/bin/bash&quot;</span><span style="color:#F8F8F2;">]</span></span>
<span class="line"><span style="color:#F92672;">    tty</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">true</span></span>
<span class="line"><span style="color:#F92672;">    logging</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">      driver</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">json-file</span></span>
<span class="line"><span style="color:#F92672;">      options</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">        max-size</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">100m</span></span>
<span class="line"><span style="color:#F92672;">        max-file</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&quot;3&quot;</span></span>
<span class="line"><span style="color:#F92672;">    restart</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">on-failure</span></span>
<span class="line"><span style="color:#F92672;">    networks</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      - </span><span style="color:#E6DB74;">datax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672;">networks</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">  datax</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">    driver</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">bridge</span></span>
<span class="line"><span style="color:#F92672;">    ipam</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">      config</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">        - </span><span style="color:#F92672;">subnet</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">172.30.0.0/16</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><h2 id="全量同步数据" tabindex="-1">全量同步数据 <a class="header-anchor" href="#全量同步数据" aria-label="Permalink to “全量同步数据”">​</a></h2><p>需要进度datax容器中执行</p><p>step01 执行命令行生成配置文件<code>mysql2postgres.json</code></p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2;" tabindex="0" dir="ltr"><code><span class="line"><span style="color:#A6E22E;">python</span><span style="color:#E6DB74;"> /root/datax/bin/datax.py</span><span style="color:#AE81FF;"> -r</span><span style="color:#E6DB74;"> mysqlreader</span><span style="color:#AE81FF;"> -w</span><span style="color:#E6DB74;"> postgresqlwriter</span><span style="color:#F92672;"> |</span><span style="color:#A6E22E;"> tee</span><span style="color:#E6DB74;"> mysql2postgres.json</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>step02 编辑配置文件<code>mysql2postgres.json</code></p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2;" tabindex="0" dir="ltr"><code><span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#E6DB74;">    &quot;job&quot;</span><span style="color:#F8F8F2;">: {</span></span>
<span class="line"><span style="color:#E6DB74;">        &quot;content&quot;</span><span style="color:#F8F8F2;">: [</span></span>
<span class="line"><span style="color:#F8F8F2;">            {</span></span>
<span class="line"><span style="color:#E6DB74;">                &quot;reader&quot;</span><span style="color:#F8F8F2;">: {</span></span>
<span class="line"><span style="color:#E6DB74;">                    &quot;name&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&quot;mysqlreader&quot;</span><span style="color:#F8F8F2;">, </span></span>
<span class="line"><span style="color:#E6DB74;">                    &quot;parameter&quot;</span><span style="color:#F8F8F2;">: {</span></span>
<span class="line"><span style="color:#E6DB74;">                        &quot;column&quot;</span><span style="color:#F8F8F2;">: [</span><span style="color:#E6DB74;">&quot;id&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&quot;name&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&quot;created_time&quot;</span><span style="color:#F8F8F2;">], </span></span>
<span class="line"><span style="color:#E6DB74;">                        &quot;connection&quot;</span><span style="color:#F8F8F2;">: [</span></span>
<span class="line"><span style="color:#F8F8F2;">                            {</span></span>
<span class="line"><span style="color:#E6DB74;">                                &quot;jdbcUrl&quot;</span><span style="color:#F8F8F2;">: [</span><span style="color:#E6DB74;">&quot;jdbc:mysql://192.168.10.11:13306/db01&quot;</span><span style="color:#F8F8F2;">], </span></span>
<span class="line"><span style="color:#E6DB74;">                                &quot;table&quot;</span><span style="color:#F8F8F2;">: [</span><span style="color:#E6DB74;">&quot;tb01&quot;</span><span style="color:#F8F8F2;">]</span></span>
<span class="line"><span style="color:#F8F8F2;">                            }</span></span>
<span class="line"><span style="color:#F8F8F2;">                        ], </span></span>
<span class="line"><span style="color:#E6DB74;">                        &quot;password&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&quot;root&quot;</span><span style="color:#F8F8F2;">, </span></span>
<span class="line"><span style="color:#E6DB74;">                        &quot;username&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&quot;root&quot;</span><span style="color:#F8F8F2;">, </span></span>
<span class="line"><span style="color:#E6DB74;">                        &quot;where&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&quot;&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">                    }</span></span>
<span class="line"><span style="color:#F8F8F2;">                }, </span></span>
<span class="line"><span style="color:#E6DB74;">                &quot;writer&quot;</span><span style="color:#F8F8F2;">: {</span></span>
<span class="line"><span style="color:#E6DB74;">                    &quot;name&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&quot;postgresqlwriter&quot;</span><span style="color:#F8F8F2;">, </span></span>
<span class="line"><span style="color:#E6DB74;">                    &quot;parameter&quot;</span><span style="color:#F8F8F2;">: {</span></span>
<span class="line"><span style="color:#E6DB74;">                        &quot;column&quot;</span><span style="color:#F8F8F2;">: [</span><span style="color:#E6DB74;">&quot;id&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&quot;name&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&quot;created_time&quot;</span><span style="color:#F8F8F2;">], </span></span>
<span class="line"><span style="color:#E6DB74;">                        &quot;connection&quot;</span><span style="color:#F8F8F2;">: [</span></span>
<span class="line"><span style="color:#F8F8F2;">                            {</span></span>
<span class="line"><span style="color:#E6DB74;">                                &quot;jdbcUrl&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&quot;jdbc:postgresql://192.168.10.11:15432/db01&quot;</span><span style="color:#F8F8F2;">, </span></span>
<span class="line"><span style="color:#E6DB74;">                                &quot;table&quot;</span><span style="color:#F8F8F2;">: [</span><span style="color:#E6DB74;">&quot;tb01&quot;</span><span style="color:#F8F8F2;">]</span></span>
<span class="line"><span style="color:#F8F8F2;">                            }</span></span>
<span class="line"><span style="color:#F8F8F2;">                        ], </span></span>
<span class="line"><span style="color:#E6DB74;">                        &quot;password&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&quot;testfind.12&quot;</span><span style="color:#F8F8F2;">, </span></span>
<span class="line"><span style="color:#E6DB74;">                        &quot;postSql&quot;</span><span style="color:#F8F8F2;">: [], </span></span>
<span class="line"><span style="color:#E6DB74;">                        &quot;preSql&quot;</span><span style="color:#F8F8F2;">: [], </span></span>
<span class="line"><span style="color:#E6DB74;">                        &quot;username&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&quot;postgres&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">                    }</span></span>
<span class="line"><span style="color:#F8F8F2;">                }</span></span>
<span class="line"><span style="color:#F8F8F2;">            }</span></span>
<span class="line"><span style="color:#F8F8F2;">        ], </span></span>
<span class="line"><span style="color:#E6DB74;">        &quot;setting&quot;</span><span style="color:#F8F8F2;">: {</span></span>
<span class="line"><span style="color:#E6DB74;">            &quot;speed&quot;</span><span style="color:#F8F8F2;">: {</span></span>
<span class="line"><span style="color:#E6DB74;">                &quot;channel&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">1</span></span>
<span class="line"><span style="color:#F8F8F2;">            }</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>step03 执命令行同步数据</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2;" tabindex="0" dir="ltr"><code><span class="line"><span style="color:#A6E22E;">python</span><span style="color:#E6DB74;"> /root/datax/bin/datax.py</span><span style="color:#E6DB74;"> mysql2postgres.json</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="增量同步数据" tabindex="-1">增量同步数据 <a class="header-anchor" href="#增量同步数据" aria-label="Permalink to “增量同步数据”">​</a></h2><ul><li>想要增量同步数据，原表也就是下面示例中的<code>db01.tb01</code>中需要有字段<code>created_time</code>来判断需要同步哪些数据</li><li>同步完数据后需要将原表的数据库名、表明、同步时间、同步数据数量等记录在中间表<code>record.tb_sync_record</code>中</li></ul><h3 id="记录同步数据表结构" tabindex="-1">记录同步数据表结构 <a class="header-anchor" href="#记录同步数据表结构" aria-label="Permalink to “记录同步数据表结构”">​</a></h3><p>建一个中间表用于记录表的同步信息</p><p><code>record.tb_sync_record</code></p><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2;" tabindex="0" dir="ltr"><code><span class="line"><span style="color:#88846F;">-- DROP TABLE IF EXISTS \`tb_sync_record\`;</span></span>
<span class="line"><span style="color:#F92672;">CREATE</span><span style="color:#F92672;"> TABLE</span><span style="color:#F8F8F2;"> \`</span><span style="color:#A6E22E;">tb_sync_record</span><span style="color:#F8F8F2;">\`  (</span></span>
<span class="line"><span style="color:#E6DB74;">  \`id\`</span><span style="color:#66D9EF;font-style:italic;"> int</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">11</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">NOT NULL</span><span style="color:#F8F8F2;"> AUTO_INCREMENT,</span></span>
<span class="line"><span style="color:#E6DB74;">  \`db_name\`</span><span style="color:#66D9EF;font-style:italic;"> varchar</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">32</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">CHARACTER</span><span style="color:#F92672;"> SET</span><span style="color:#F8F8F2;"> utf8mb4 </span><span style="color:#F92672;">COLLATE</span><span style="color:#F8F8F2;"> utf8mb4_general_ci </span><span style="color:#F92672;">NOT NULL</span><span style="color:#F8F8F2;"> COMMENT </span><span style="color:#E6DB74;">&#39;数据库名称&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#E6DB74;">  \`tb_name\`</span><span style="color:#66D9EF;font-style:italic;"> varchar</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">32</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">CHARACTER</span><span style="color:#F92672;"> SET</span><span style="color:#F8F8F2;"> utf8mb4 </span><span style="color:#F92672;">COLLATE</span><span style="color:#F8F8F2;"> utf8mb4_general_ci </span><span style="color:#F92672;">NOT NULL</span><span style="color:#F8F8F2;"> COMMENT </span><span style="color:#E6DB74;">&#39;表名称&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#E6DB74;">  \`last_time\`</span><span style="color:#F92672;"> datetime</span><span style="color:#F92672;"> NOT NULL</span><span style="color:#F8F8F2;"> COMMENT </span><span style="color:#E6DB74;">&#39;同步时间&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#E6DB74;">  \`read_num\`</span><span style="color:#66D9EF;font-style:italic;"> int</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">11</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">NOT NULL</span><span style="color:#F8F8F2;"> COMMENT </span><span style="color:#E6DB74;">&#39;读出记录总数&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#E6DB74;">  \`write_failed_num\`</span><span style="color:#66D9EF;font-style:italic;"> int</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">11</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">NOT NULL</span><span style="color:#F8F8F2;"> COMMENT </span><span style="color:#E6DB74;">&#39;读写失败总数&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F92672;">  PRIMARY KEY</span><span style="color:#F8F8F2;"> (</span><span style="color:#E6DB74;">\`id\`</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">USING</span><span style="color:#F8F8F2;"> BTREE</span></span>
<span class="line"><span style="color:#F8F8F2;">) ENGINE </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> InnoDB AUTO_INCREMENT </span><span style="color:#F92672;">=</span><span style="color:#AE81FF;"> 38</span><span style="color:#F92672;"> CHARACTER</span><span style="color:#F92672;"> SET</span><span style="color:#F92672;"> =</span><span style="color:#F8F8F2;"> utf8mb4 </span><span style="color:#F92672;">COLLATE</span><span style="color:#F92672;"> =</span><span style="color:#F8F8F2;"> utf8mb4_general_ci ROW_FORMAT </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> DYNAMIC</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">-- ----------------------------</span></span>
<span class="line"><span style="color:#88846F;">-- Records of tb_sync_record</span></span>
<span class="line"><span style="color:#88846F;">-- ----------------------------</span></span>
<span class="line"><span style="color:#F92672;">INSERT INTO</span><span style="color:#E6DB74;"> \`tb_sync_record\`</span><span style="color:#F92672;"> VALUES</span><span style="color:#F8F8F2;"> (</span><span style="color:#AE81FF;">1</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&#39;db01&#39;</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&#39;tb01&#39;</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&#39;2024-01-01 00:00:00&#39;</span><span style="color:#F8F8F2;">, </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">, </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="配置文件" tabindex="-1">配置文件 <a class="header-anchor" href="#配置文件" aria-label="Permalink to “配置文件”">​</a></h3><p>需要在<code>job.content[0].writer.parameter.where</code>中添加<code>created_time</code>字段的判断条件，来表示需要同步哪些数据</p><p><code>workspace/mysql2postgres.json</code></p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2;" tabindex="0" dir="ltr"><code><span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">    &quot;job&quot;</span><span style="color:#F8F8F2;">: {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        &quot;content&quot;</span><span style="color:#F8F8F2;">: [</span></span>
<span class="line"><span style="color:#F8F8F2;">            {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                &quot;reader&quot;</span><span style="color:#F8F8F2;">: {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                    &quot;name&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#CFCFC2;">&quot;mysqlreader&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                    &quot;parameter&quot;</span><span style="color:#F8F8F2;">: {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                        &quot;column&quot;</span><span style="color:#F8F8F2;">: [</span></span>
<span class="line"><span style="color:#CFCFC2;">                            &quot;*&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">                        ],</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                        &quot;connection&quot;</span><span style="color:#F8F8F2;">: [</span></span>
<span class="line"><span style="color:#F8F8F2;">                            {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                                &quot;jdbcUrl&quot;</span><span style="color:#F8F8F2;">: [</span></span>
<span class="line"><span style="color:#CFCFC2;">                                    &quot;jdbc:mysql://192.168.10.11:13306/db01?serverTimezone=Asia/Shanghai&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">                                ],</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                                &quot;table&quot;</span><span style="color:#F8F8F2;">: [</span></span>
<span class="line"><span style="color:#CFCFC2;">                                    &quot;tb01&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">                                ]</span></span>
<span class="line"><span style="color:#F8F8F2;">                            }</span></span>
<span class="line"><span style="color:#F8F8F2;">                        ],</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                        &quot;password&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#CFCFC2;">&quot;root&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                        &quot;username&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#CFCFC2;">&quot;root&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line highlighted"><span style="color:#66D9EF;font-style:italic;">                        &quot;where&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#CFCFC2;">&quot;created_time &gt;= (select max(last_time) from record.tb_sync_record where db_name=&#39;db01&#39; and tb_name=&#39;tb01&#39;) and created_time &lt;= FROM_UNIXTIME(\${current_time})&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">                    }</span></span>
<span class="line"><span style="color:#F8F8F2;">                },</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                &quot;writer&quot;</span><span style="color:#F8F8F2;">: {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                    &quot;name&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#CFCFC2;">&quot;postgresqlwriter&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                    &quot;parameter&quot;</span><span style="color:#F8F8F2;">: {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                        &quot;column&quot;</span><span style="color:#F8F8F2;">: [</span></span>
<span class="line"><span style="color:#CFCFC2;">                            &quot;*&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">                        ],</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                        &quot;connection&quot;</span><span style="color:#F8F8F2;">: [</span></span>
<span class="line"><span style="color:#F8F8F2;">                            {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                                &quot;jdbcUrl&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#CFCFC2;">&quot;jdbc:postgresql://192.168.10.11:15432/db01&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                                &quot;table&quot;</span><span style="color:#F8F8F2;">: [</span></span>
<span class="line"><span style="color:#CFCFC2;">                                    &quot;tb01&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">                                ]</span></span>
<span class="line"><span style="color:#F8F8F2;">                            }</span></span>
<span class="line"><span style="color:#F8F8F2;">                        ],</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                        &quot;password&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#CFCFC2;">&quot;testfind.12&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                        &quot;postSql&quot;</span><span style="color:#F8F8F2;">: [],</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                        &quot;preSql&quot;</span><span style="color:#F8F8F2;">: [],</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                        &quot;username&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#CFCFC2;">&quot;postgres&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">                    }</span></span>
<span class="line"><span style="color:#F8F8F2;">                }</span></span>
<span class="line"><span style="color:#F8F8F2;">            }</span></span>
<span class="line"><span style="color:#F8F8F2;">        ],</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        &quot;setting&quot;</span><span style="color:#F8F8F2;">: {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">            &quot;speed&quot;</span><span style="color:#F8F8F2;">: {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                &quot;channel&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">3</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                &quot;byte&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">1048576</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                &quot;record&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">1000</span></span>
<span class="line"><span style="color:#F8F8F2;">            },</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">            &quot;errorLimit&quot;</span><span style="color:#F8F8F2;">: {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                &quot;record&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">2</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                &quot;percentage&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">0.02</span></span>
<span class="line"><span style="color:#F8F8F2;">            }</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><h3 id="同步程序" tabindex="-1">同步程序 <a class="header-anchor" href="#同步程序" aria-label="Permalink to “同步程序”">​</a></h3><p>同步完数据后需要将同步信息记录在表中</p><p><code>workspace/SyncRecordToMysql.java</code></p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2;" tabindex="0" dir="ltr"><code><span class="line"><span style="color:#F92672;">import</span><span style="color:#F92672;"> com.alibaba.datax.common.util.Configuration</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F92672;"> com.alibaba.fastjson.JSONReader</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F92672;"> org.slf4j.Logger</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F92672;"> org.slf4j.LoggerFactory</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F92672;"> java.io.</span><span style="color:#FD971F;">*</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F92672;"> java.sql.Connection</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F92672;"> java.sql.DriverManager</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F92672;"> java.sql.SQLException</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F92672;"> java.sql.Statement</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672;">public</span><span style="color:#F92672;"> class</span><span> </span><span style="color:#A6E22E;text-decoration:underline;">SyncRecordToMysql</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F92672;">    public</span><span style="color:#F92672;"> static</span><span style="color:#66D9EF;font-style:italic;"> Logger</span><span style="color:#F8F8F2;"> logger </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> LoggerFactory.</span><span style="color:#A6E22E;">getLogger</span><span style="color:#F8F8F2;">(SyncRecordToMysql.class);</span></span>
<span class="line"><span style="color:#F92672;">    public</span><span style="color:#F92672;"> static</span><span style="color:#F92672;"> final</span><span style="color:#66D9EF;font-style:italic;"> String</span><span style="color:#F8F8F2;"> driver </span><span style="color:#F92672;">=</span><span style="color:#E6DB74;"> &quot;com.mysql.jdbc.Driver&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672;">    public</span><span style="color:#F92672;"> static</span><span style="color:#66D9EF;font-style:italic;"> void</span><span style="color:#A6E22E;"> main</span><span style="color:#F8F8F2;">(</span><span style="color:#66D9EF;font-style:italic;">String</span><span style="color:#F8F8F2;">[] </span><span style="color:#FD971F;font-style:italic;">args</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">throws</span><span style="color:#66D9EF;font-style:italic;"> IOException</span><span style="color:#F8F8F2;">, </span><span style="color:#66D9EF;font-style:italic;">ClassNotFoundException</span><span style="color:#F8F8F2;">, </span><span style="color:#66D9EF;font-style:italic;">SQLException</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;"> jsonFile </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> System.</span><span style="color:#A6E22E;">getProperty</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;custom.jsonFile&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;"> syncDatabaseName </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> System.</span><span style="color:#A6E22E;">getProperty</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;custom.syncDatabaseName&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&quot;record&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;"> syncTableName </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> System.</span><span style="color:#A6E22E;">getProperty</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;custom.syncTableName&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">&quot;tb_sync_record&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;"> lastTime </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> System.</span><span style="color:#A6E22E;">getProperty</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;custom.lastTime&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        int</span><span style="color:#F8F8F2;"> readNum </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> Integer.</span><span style="color:#A6E22E;">parseInt</span><span style="color:#F8F8F2;">(System.</span><span style="color:#A6E22E;">getProperty</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;custom.readNum&quot;</span><span style="color:#F8F8F2;">));</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        int</span><span style="color:#F8F8F2;"> writeFailedNum </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> Integer.</span><span style="color:#A6E22E;">parseInt</span><span style="color:#F8F8F2;">(System.</span><span style="color:#A6E22E;">getProperty</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;custom.writeFailedNum&quot;</span><span style="color:#F8F8F2;">));</span></span>
<span class="line"><span style="color:#F8F8F2;">        logger.</span><span style="color:#A6E22E;">info</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;jsonFile: {}, syncDatabaseName: {}, syncTableName: {}, lastTime: {}&quot;</span><span style="color:#F8F8F2;">, jsonFile, syncDatabaseName, syncTableName, lastTime);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">        // get json</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        FileReader</span><span style="color:#F8F8F2;"> fileReader </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> new</span><span style="color:#A6E22E;"> FileReader</span><span style="color:#F8F8F2;">(jsonFile);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        JSONReader</span><span style="color:#F8F8F2;"> jsonReader </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> new</span><span style="color:#A6E22E;"> JSONReader</span><span style="color:#F8F8F2;">(fileReader);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;"> jsonString </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> jsonReader.</span><span style="color:#A6E22E;">readString</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#88846F;">        // get configuration</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        Configuration</span><span style="color:#F8F8F2;"> configuration </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> Configuration.</span><span style="color:#A6E22E;">from</span><span style="color:#F8F8F2;">(jsonString);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;"> username </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> configuration.</span><span style="color:#A6E22E;">getString</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;job.content[0].reader.parameter.username&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;"> password </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> configuration.</span><span style="color:#A6E22E;">getString</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;job.content[0].reader.parameter.password&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;"> srcTableName </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> configuration.</span><span style="color:#A6E22E;">getString</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;job.content[0].reader.parameter.connection[0].table[0]&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;"> srcJdbcUrl </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> configuration.</span><span style="color:#A6E22E;">getString</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;job.content[0].reader.parameter.connection[0].jdbcUrl[0]&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#88846F;">        // get syncJdbcUrl</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;"> syncJdbcUrl </span><span style="color:#F92672;">=</span><span style="color:#A6E22E;"> getSyncJdbcUrl</span><span style="color:#F8F8F2;">(srcJdbcUrl, syncDatabaseName);</span></span>
<span class="line"><span style="color:#88846F;">        // get srcDatabaseName</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;"> srcDatabaseName </span><span style="color:#F92672;">=</span><span style="color:#A6E22E;"> getSrcDatabaseName</span><span style="color:#F8F8F2;">(srcJdbcUrl);</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        boolean</span><span style="color:#F8F8F2;"> write </span><span style="color:#F92672;">=</span><span style="color:#A6E22E;"> write</span><span style="color:#F8F8F2;">(username, password,</span></span>
<span class="line"><span style="color:#F8F8F2;">                syncJdbcUrl, syncTableName,</span></span>
<span class="line"><span style="color:#F8F8F2;">                srcDatabaseName, srcTableName,</span></span>
<span class="line"><span style="color:#F8F8F2;">                lastTime, readNum, writeFailedNum);</span></span>
<span class="line"><span style="color:#F92672;">        if</span><span style="color:#F8F8F2;"> (write) {</span></span>
<span class="line"><span style="color:#F8F8F2;">            logger.</span><span style="color:#A6E22E;">info</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;sync record to {} success&quot;</span><span style="color:#F8F8F2;">, syncTableName);</span></span>
<span class="line"><span style="color:#F8F8F2;">        } </span><span style="color:#F92672;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">            logger.</span><span style="color:#A6E22E;">info</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;sync record to {} failed&quot;</span><span style="color:#F8F8F2;">, syncTableName);</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">        jsonReader.</span><span style="color:#A6E22E;">close</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">        fileReader.</span><span style="color:#A6E22E;">close</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">    /**</span></span>
<span class="line"><span style="color:#88846F;">     * </span><span style="color:#F92672;">@param</span><span style="color:#FD971F;font-style:italic;"> username</span><span style="color:#88846F;">        数据库的用户名</span></span>
<span class="line"><span style="color:#88846F;">     * </span><span style="color:#F92672;">@param</span><span style="color:#FD971F;font-style:italic;"> password</span><span style="color:#88846F;">        数据库的密码</span></span>
<span class="line"><span style="color:#88846F;">     * </span><span style="color:#F92672;">@param</span><span style="color:#FD971F;font-style:italic;"> syncJdbcUrl</span><span style="color:#88846F;">     信息同步表的jdbcUrl</span></span>
<span class="line"><span style="color:#88846F;">     * </span><span style="color:#F92672;">@param</span><span style="color:#FD971F;font-style:italic;"> syncTableName</span><span style="color:#88846F;">   信息同步表的表名称</span></span>
<span class="line"><span style="color:#88846F;">     * </span><span style="color:#F92672;">@param</span><span style="color:#FD971F;font-style:italic;"> srcDatabaseName</span><span style="color:#88846F;"> 源表的数据库名称</span></span>
<span class="line"><span style="color:#88846F;">     * </span><span style="color:#F92672;">@param</span><span style="color:#FD971F;font-style:italic;"> srcTableName</span><span style="color:#88846F;">    源表的表名称</span></span>
<span class="line"><span style="color:#88846F;">     * </span><span style="color:#F92672;">@param</span><span style="color:#FD971F;font-style:italic;"> lastTime</span><span style="color:#88846F;">        最新的同步时间</span></span>
<span class="line"><span style="color:#88846F;">     * </span><span style="color:#F92672;">@param</span><span style="color:#FD971F;font-style:italic;"> readNum</span><span style="color:#88846F;">         读出记录总数</span></span>
<span class="line"><span style="color:#88846F;">     * </span><span style="color:#F92672;">@param</span><span style="color:#FD971F;font-style:italic;"> writeFailedNum</span><span style="color:#88846F;">  读写失败总数</span></span>
<span class="line"><span style="color:#88846F;">     * </span><span style="color:#F92672;">@return</span><span style="color:#88846F;"> 写入同步信息，并返回结果</span></span>
<span class="line"><span style="color:#88846F;">     */</span></span>
<span class="line"><span style="color:#F92672;">    public</span><span style="color:#F92672;"> static</span><span style="color:#66D9EF;font-style:italic;"> boolean</span><span style="color:#A6E22E;"> write</span><span style="color:#F8F8F2;">(</span><span style="color:#66D9EF;font-style:italic;">String</span><span style="color:#FD971F;font-style:italic;"> username</span><span style="color:#F8F8F2;">, </span><span style="color:#66D9EF;font-style:italic;">String</span><span style="color:#FD971F;font-style:italic;"> password</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                                String</span><span style="color:#FD971F;font-style:italic;"> syncJdbcUrl</span><span style="color:#F8F8F2;">, </span><span style="color:#66D9EF;font-style:italic;">String</span><span style="color:#FD971F;font-style:italic;"> syncTableName</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                                String</span><span style="color:#FD971F;font-style:italic;"> srcDatabaseName</span><span style="color:#F8F8F2;">, </span><span style="color:#66D9EF;font-style:italic;">String</span><span style="color:#FD971F;font-style:italic;"> srcTableName</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">                                String</span><span style="color:#FD971F;font-style:italic;"> lastTime</span><span style="color:#F8F8F2;">, </span><span style="color:#66D9EF;font-style:italic;">int</span><span style="color:#FD971F;font-style:italic;"> readNum</span><span style="color:#F8F8F2;">, </span><span style="color:#66D9EF;font-style:italic;">int</span><span style="color:#FD971F;font-style:italic;"> writeFailedNum</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">throws</span><span style="color:#66D9EF;font-style:italic;"> ClassNotFoundException</span><span style="color:#F8F8F2;">, </span><span style="color:#66D9EF;font-style:italic;">SQLException</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;"> stmt </span><span style="color:#F92672;">=</span><span style="color:#E6DB74;"> &quot;insert into &quot;</span><span style="color:#F92672;"> +</span><span style="color:#F8F8F2;"> syncTableName </span><span style="color:#F92672;">+</span><span style="color:#E6DB74;"> &quot;(db_name, tb_name , last_time, read_num, write_failed_num) value (&#39;&quot;</span><span style="color:#F92672;"> +</span><span style="color:#F8F8F2;"> srcDatabaseName </span><span style="color:#F92672;">+</span><span style="color:#E6DB74;"> &quot;&#39;, &#39;&quot;</span><span style="color:#F92672;"> +</span><span style="color:#F8F8F2;"> srcTableName </span><span style="color:#F92672;">+</span><span style="color:#E6DB74;"> &quot;&#39;, FROM_UNIXTIME(&quot;</span><span style="color:#F92672;"> +</span><span style="color:#F8F8F2;"> lastTime </span><span style="color:#F92672;">+</span><span style="color:#E6DB74;"> &quot;), &quot;</span><span style="color:#F92672;"> +</span><span style="color:#F8F8F2;"> readNum </span><span style="color:#F92672;">+</span><span style="color:#E6DB74;"> &quot;, &quot;</span><span style="color:#F92672;"> +</span><span style="color:#F8F8F2;"> writeFailedNum </span><span style="color:#F92672;">+</span><span style="color:#E6DB74;"> &quot;)&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">        logger.</span><span style="color:#A6E22E;">info</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;stmt: {}&quot;</span><span style="color:#F8F8F2;">, stmt);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        Class.</span><span style="color:#A6E22E;">forName</span><span style="color:#F8F8F2;">(driver);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        Connection</span><span style="color:#F8F8F2;"> connection </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> DriverManager.</span><span style="color:#A6E22E;">getConnection</span><span style="color:#F8F8F2;">(syncJdbcUrl, username, password);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        Statement</span><span style="color:#F8F8F2;"> statement </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> connection.</span><span style="color:#A6E22E;">createStatement</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        int</span><span style="color:#F8F8F2;"> count </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> statement.</span><span style="color:#A6E22E;">executeUpdate</span><span style="color:#F8F8F2;">(stmt);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        statement.</span><span style="color:#A6E22E;">close</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">        connection.</span><span style="color:#A6E22E;">close</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F92672;">        return</span><span style="color:#F8F8F2;"> count </span><span style="color:#F92672;">==</span><span style="color:#AE81FF;"> 1</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">    /**</span></span>
<span class="line"><span style="color:#88846F;">     * </span><span style="color:#F92672;">@param</span><span style="color:#FD971F;font-style:italic;"> srcJdbcUrl</span><span style="color:#88846F;"> 源表的jdbcUrl</span></span>
<span class="line"><span style="color:#88846F;">     * </span><span style="color:#F92672;">@return</span><span style="color:#88846F;"> 根据源表的jdbcUrl获取源表的数据库名称</span></span>
<span class="line"><span style="color:#88846F;">     */</span></span>
<span class="line"><span style="color:#F92672;">    public</span><span style="color:#F92672;"> static</span><span style="color:#66D9EF;font-style:italic;"> String</span><span style="color:#A6E22E;"> getSrcDatabaseName</span><span style="color:#F8F8F2;">(</span><span style="color:#66D9EF;font-style:italic;">String</span><span style="color:#FD971F;font-style:italic;"> srcJdbcUrl</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;">[] url </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> srcJdbcUrl.</span><span style="color:#A6E22E;">split</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;</span><span style="color:#AE81FF;">\\\\</span><span style="color:#E6DB74;">?&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;"> urlPrefix </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> url[</span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">];</span></span>
<span class="line"><span style="color:#F92672;">        return</span><span style="color:#F8F8F2;"> urlPrefix.</span><span style="color:#A6E22E;">substring</span><span style="color:#F8F8F2;">(urlPrefix.</span><span style="color:#A6E22E;">lastIndexOf</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;/&quot;</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">+</span><span style="color:#AE81FF;"> 1</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">    /**</span></span>
<span class="line"><span style="color:#88846F;">     * </span><span style="color:#F92672;">@param</span><span style="color:#FD971F;font-style:italic;"> srcJdbcUrl</span><span style="color:#88846F;">       源表的jdbcUrl</span></span>
<span class="line"><span style="color:#88846F;">     * </span><span style="color:#F92672;">@param</span><span style="color:#FD971F;font-style:italic;"> syncDatabaseName</span><span style="color:#88846F;"> 同步信息表的数据库名称</span></span>
<span class="line"><span style="color:#88846F;">     * </span><span style="color:#F92672;">@return</span><span style="color:#88846F;"> 根据源表的jdbcUrl和同步信息表的数据库名称获取同步信息表的jdbcUrl</span></span>
<span class="line"><span style="color:#88846F;">     */</span></span>
<span class="line"><span style="color:#F92672;">    public</span><span style="color:#F92672;"> static</span><span style="color:#66D9EF;font-style:italic;"> String</span><span style="color:#A6E22E;"> getSyncJdbcUrl</span><span style="color:#F8F8F2;">(</span><span style="color:#66D9EF;font-style:italic;">String</span><span style="color:#FD971F;font-style:italic;"> srcJdbcUrl</span><span style="color:#F8F8F2;">, </span><span style="color:#66D9EF;font-style:italic;">String</span><span style="color:#FD971F;font-style:italic;"> syncDatabaseName</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        StringBuilder</span><span style="color:#F8F8F2;"> stringBuilder </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> new</span><span style="color:#A6E22E;"> StringBuilder</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;">[] url </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> srcJdbcUrl.</span><span style="color:#A6E22E;">split</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;</span><span style="color:#AE81FF;">\\\\</span><span style="color:#E6DB74;">?&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;"> urlPrefix </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> url[</span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">];</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">        String</span><span style="color:#F8F8F2;"> urlSuffix </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> url.length </span><span style="color:#F92672;">&gt;=</span><span style="color:#AE81FF;"> 2</span><span style="color:#F92672;"> ?</span><span style="color:#F8F8F2;"> url[</span><span style="color:#AE81FF;">1</span><span style="color:#F8F8F2;">] </span><span style="color:#F92672;">:</span><span style="color:#E6DB74;"> &quot;&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">        stringBuilder.</span><span style="color:#A6E22E;">append</span><span style="color:#F8F8F2;">(urlPrefix.</span><span style="color:#A6E22E;">replace</span><span style="color:#F8F8F2;">(urlPrefix.</span><span style="color:#A6E22E;">substring</span><span style="color:#F8F8F2;">(urlPrefix.</span><span style="color:#A6E22E;">lastIndexOf</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;/&quot;</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">+</span><span style="color:#AE81FF;"> 1</span><span style="color:#F8F8F2;">), syncDatabaseName));</span></span>
<span class="line"><span style="color:#F8F8F2;">        stringBuilder.</span><span style="color:#A6E22E;">append</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;?&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">        stringBuilder.</span><span style="color:#A6E22E;">append</span><span style="color:#F8F8F2;">(urlSuffix);</span></span>
<span class="line"><span style="color:#F92672;">        return</span><span style="color:#F8F8F2;"> stringBuilder.</span><span style="color:#A6E22E;">toString</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br></div></div><h3 id="启动脚本" tabindex="-1">启动脚本 <a class="header-anchor" href="#启动脚本" aria-label="Permalink to “启动脚本”">​</a></h3><p>启动脚本中定义了执行流程和需要传入的参数</p><p><code>workspace/start.sh</code></p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2;" tabindex="0" dir="ltr"><code><span class="line"><span style="color:#88846F;">#!/bin/bash</span></span>
<span class="line"><span style="color:#66D9EF;">set</span><span style="color:#AE81FF;"> -x</span></span>
<span class="line"><span style="color:#66D9EF;">set</span><span style="color:#AE81FF;"> -e</span></span>
<span class="line"><span style="color:#66D9EF;">set</span><span style="color:#AE81FF;"> -o</span><span style="color:#E6DB74;"> pipefail</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">path_javac</span><span style="color:#F92672;">=</span><span style="color:#E6DB74;">&quot;/root/java/bin/javac&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">path_datax</span><span style="color:#F92672;">=</span><span style="color:#E6DB74;">&quot;/root/datax/bin/datax.py&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">items</span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&quot;mysql2postgres.json&quot;</span><span style="color:#E6DB74;"> &quot;mysql2postgres2.json&quot;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">sync_database_name</span><span style="color:#F92672;">=</span><span style="color:#E6DB74;">&quot;record&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">sync_table_name</span><span style="color:#F92672;">=</span><span style="color:#E6DB74;">&quot;tb_sync_record&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">current_time</span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;">$(</span><span style="color:#A6E22E;">date</span><span style="color:#E6DB74;"> +%s</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">log_file</span><span style="color:#F92672;">=</span><span style="color:#E6DB74;">&quot;datax.log&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#A6E22E;"> compile_java</span><span style="color:#F8F8F2;">(){</span></span>
<span class="line"><span style="color:#F8F8F2;">	\${path_javac} </span><span style="color:#AE81FF;">-encoding</span><span style="color:#E6DB74;"> utf-8</span><span style="color:#AE81FF;"> -classpath</span><span style="color:#E6DB74;"> &quot;/root/datax/plugin/reader/mysqlreader/libs/*:.&quot;</span><span style="color:#E6DB74;"> SyncRecordToMysql.java</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#A6E22E;"> execute_datax</span><span style="color:#F8F8F2;">(){</span></span>
<span class="line"><span style="color:#F92672;">	for</span><span style="color:#F8F8F2;"> item </span><span style="color:#F92672;">in</span><span style="color:#F8F8F2;"> \${items[</span><span style="color:#F92672;">@</span><span style="color:#F8F8F2;">]}</span></span>
<span class="line"><span style="color:#F92672;">	do</span></span>
<span class="line"><span style="color:#A6E22E;">		python</span><span style="color:#F8F8F2;"> $path_datax $item </span><span style="color:#AE81FF;">-p</span><span style="color:#E6DB74;"> &quot;-Dcurrent_time=\${</span><span style="color:#F8F8F2;">current_time</span><span style="color:#E6DB74;">}&quot;</span><span style="color:#F92672;"> |</span><span style="color:#A6E22E;"> tee</span><span style="color:#E6DB74;"> datax.log</span></span>
<span class="line"><span style="color:#F92672;">		if</span><span style="color:#F8F8F2;"> [ </span><span style="color:#FD971F;">$?</span><span style="color:#F92672;"> -eq</span><span style="color:#AE81FF;"> 0</span><span style="color:#F8F8F2;"> ];</span><span style="color:#F92672;">then</span></span>
<span class="line"><span style="color:#F92672;">			local</span><span style="color:#F8F8F2;"> read_num</span></span>
<span class="line"><span style="color:#F92672;">			local</span><span style="color:#F8F8F2;"> write_faild_num</span></span>
<span class="line"><span style="color:#F8F8F2;">			read_num</span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;">$(</span><span style="color:#A6E22E;">tail</span><span style="color:#AE81FF;"> -n</span><span style="color:#AE81FF;"> 3</span><span style="color:#F8F8F2;"> \${log_file} </span><span style="color:#F92672;">|</span><span style="color:#A6E22E;"> awk</span><span style="color:#E6DB74;"> &#39;NR==1{print $NF}&#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">			write_faild_num</span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;">$(</span><span style="color:#A6E22E;">tail</span><span style="color:#AE81FF;"> -n</span><span style="color:#AE81FF;"> 3</span><span style="color:#F8F8F2;"> \${log_file} </span><span style="color:#F92672;">|</span><span style="color:#A6E22E;"> awk</span><span style="color:#E6DB74;"> &#39;NR==2{print $NF}&#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#A6E22E;">			sync_record</span><span style="color:#F8F8F2;"> \${item} \${read_num} \${write_faild_num} </span></span>
<span class="line"><span style="color:#F92672;">		fi</span></span>
<span class="line"><span style="color:#F92672;">	done</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#A6E22E;"> sync_record</span><span style="color:#F8F8F2;">(){</span></span>
<span class="line"><span style="color:#F92672;">	local</span><span style="color:#F8F8F2;"> json_file</span><span style="color:#F92672;">=</span><span style="color:#FD971F;font-style:italic;">\${1}</span></span>
<span class="line"><span style="color:#F92672;">	local</span><span style="color:#F8F8F2;"> read_num</span><span style="color:#F92672;">=</span><span style="color:#FD971F;font-style:italic;">\${2}</span></span>
<span class="line"><span style="color:#F92672;">	local</span><span style="color:#F8F8F2;"> write_faild_num</span><span style="color:#F92672;">=</span><span style="color:#FD971F;font-style:italic;">\${3}</span></span>
<span class="line"><span style="color:#66D9EF;">	echo</span><span style="color:#E6DB74;"> &quot;execute preSql...&quot;</span></span>
<span class="line"><span style="color:#A6E22E;">	java</span><span style="color:#AE81FF;"> -classpath</span><span style="color:#E6DB74;"> &quot;/root/datax/plugin/reader/mysqlreader/libs/*:.&quot;</span><span style="color:#AE81FF;"> -Dcustom.jsonFile=\${</span><span style="color:#F8F8F2;">json_file</span><span style="color:#AE81FF;">}</span><span style="color:#AE81FF;"> -Dcustom.syncDatabaseName=\${</span><span style="color:#F8F8F2;">sync_database_name</span><span style="color:#AE81FF;">}</span><span style="color:#AE81FF;"> -Dcustom.syncTableName=\${</span><span style="color:#F8F8F2;">sync_table_name</span><span style="color:#AE81FF;">}</span><span style="color:#AE81FF;"> -Dcustom.lastTime=\${</span><span style="color:#F8F8F2;">current_time</span><span style="color:#AE81FF;">}</span><span style="color:#AE81FF;"> -Dcustom.readNum=\${</span><span style="color:#F8F8F2;">read_num</span><span style="color:#AE81FF;">}</span><span style="color:#AE81FF;"> -Dcustom.writeFailedNum=\${</span><span style="color:#F8F8F2;">write_faild_num</span><span style="color:#AE81FF;">}</span><span style="color:#E6DB74;"> SyncRecordToMysql</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#A6E22E;"> main</span><span style="color:#F8F8F2;">(){</span></span>
<span class="line"><span style="color:#88846F;">	# compile_java</span></span>
<span class="line"><span style="color:#A6E22E;">	execute_datax</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6E22E;">main</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h3 id="dockerfile文件" tabindex="-1">dockerfile文件 <a class="header-anchor" href="#dockerfile文件" aria-label="Permalink to “dockerfile文件”">​</a></h3><p>目录结构</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2;" tabindex="0" dir="ltr"><code><span class="line"><span style="color:#88846F;"># tree</span></span>
<span class="line"><span style="color:#66D9EF;">.</span></span>
<span class="line"><span style="color:#A6E22E;">├──</span><span style="color:#E6DB74;"> dockerfile</span></span>
<span class="line"><span style="color:#A6E22E;">└──</span><span style="color:#E6DB74;"> workspace</span></span>
<span class="line"><span style="color:#A6E22E;">    ├──</span><span style="color:#E6DB74;"> mysql2postgres.json</span></span>
<span class="line"><span style="color:#A6E22E;">    ├──</span><span style="color:#E6DB74;"> start.sh</span></span>
<span class="line"><span style="color:#A6E22E;">    └──</span><span style="color:#E6DB74;"> SyncRecordToMysql.java</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>dockerfile</code></p><div class="language-dockerfile line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2;" tabindex="0" dir="ltr"><code><span class="line"><span style="color:#F92672;">FROM</span><span style="color:#F8F8F2;"> huas/datax</span></span>
<span class="line"><span style="color:#F92672;">COPY</span><span style="color:#F8F8F2;"> workspace /workspace</span></span>
<span class="line"><span style="color:#F92672;">WORKDIR</span><span style="color:#F8F8F2;"> /workspace</span></span>
<span class="line"><span style="color:#F92672;">RUN</span><span style="color:#F8F8F2;"> set -x &amp;&amp; \\</span></span>
<span class="line"><span style="color:#F8F8F2;">  echo Asia/Shanghai &gt; /etc/timezone &amp;&amp; \\</span></span>
<span class="line"><span style="color:#F8F8F2;">  /root/java/bin/javac -encoding utf-8 -classpath </span><span style="color:#E6DB74;">&quot;/root/datax/plugin/reader/mysqlreader/libs/*:.&quot;</span><span style="color:#F8F8F2;"> SyncRecordToMysql.java</span></span>
<span class="line"><span style="color:#F92672;">CMD</span><span style="color:#F8F8F2;"> [</span><span style="color:#E6DB74;">&quot;./start.sh&quot;</span><span style="color:#F8F8F2;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="如何部署" tabindex="-1">如何部署 <a class="header-anchor" href="#如何部署" aria-label="Permalink to “如何部署”">​</a></h2><p>如果需要定时任务来执行同步数据的任务，可以使用<code>kubernetes</code>中的控制器<code>CronJob</code>来调度任务，编排文件按需求修改🙂</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki monokai" style="background-color:#272822;color:#F8F8F2;" tabindex="0" dir="ltr"><code><span class="line"><span style="color:#F92672;">apiVersion</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">batch/v1beta1</span></span>
<span class="line"><span style="color:#F92672;">kind</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">CronJob</span></span>
<span class="line"><span style="color:#F92672;">metadata</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">  creationTimestamp</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">null</span></span>
<span class="line"><span style="color:#F92672;">  name</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">datax-job</span></span>
<span class="line"><span style="color:#F92672;">spec</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">  concurrencyPolicy</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">Forbid</span></span>
<span class="line"><span style="color:#F92672;">  failedJobsHistoryLimit</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">3</span></span>
<span class="line"><span style="color:#F92672;">  jobTemplate</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">    metadata</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">      creationTimestamp</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">null</span></span>
<span class="line"><span style="color:#F92672;">      name</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">datax-job</span></span>
<span class="line"><span style="color:#F92672;">    spec</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">      template</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">        metadata</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">          creationTimestamp</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">null</span></span>
<span class="line"><span style="color:#F92672;">        spec</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">          containers</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">          - </span><span style="color:#F92672;">image</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">harbor.example.com/emiya/datax:v1</span></span>
<span class="line"><span style="color:#F92672;">            name</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">datax-job</span></span>
<span class="line"><span style="color:#F92672;">            imagePullPolicy</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">IfNotPresent</span></span>
<span class="line"><span style="color:#F92672;">            resources</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">              limits</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">                cpu</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">1</span></span>
<span class="line"><span style="color:#F92672;">                memory</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">1Gi</span></span>
<span class="line"><span style="color:#F92672;">            volumeMounts</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">            - </span><span style="color:#F92672;">name</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">localtime</span></span>
<span class="line"><span style="color:#F92672;">              mountPath</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">/etc/localime</span></span>
<span class="line"><span style="color:#F92672;">          restartPolicy</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">OnFailure</span></span>
<span class="line"><span style="color:#F92672;">          volumes</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">          - </span><span style="color:#F92672;">name</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">localtime</span></span>
<span class="line"><span style="color:#F92672;">            hostPath</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#F92672;">              path</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">/etc/localtime</span></span>
<span class="line highlighted"><span style="color:#F92672;">  schedule</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&#39;*/10 * * * *&#39;</span></span>
<span class="line"><span style="color:#F92672;">  successfulJobsHistoryLimit</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">3</span></span>
<span class="line"><span style="color:#F92672;">  suspend</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">false</span></span>
<span class="line"><span style="color:#F92672;">status</span><span style="color:#F8F8F2;">: {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div>`,37)])])}const u=n(e,[["render",o]]);export{b as __pageData,u as default};
