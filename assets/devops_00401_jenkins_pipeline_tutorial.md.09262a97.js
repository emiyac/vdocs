import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.eabe3503.js";const b=JSON.parse('{"title":"使用gitlab和jenkins搭建持续集成环境","description":"","frontmatter":{"title":"使用gitlab和jenkins搭建持续集成环境","createTime":"2024/04/27 12:01:01","updateTime":"2024/04/27 12:01:01","isPublished":true,"tags":["git","jenkins"]},"headers":[],"relativePath":"devops/00401_jenkins_pipeline_tutorial.md","filePath":"devops/00401_jenkins_pipeline_tutorial.md"}'),p={name:"devops/00401_jenkins_pipeline_tutorial.md"},o=l(`<h2 id="docker-compose部署gitlab和jenkins" tabindex="-1">docker-compose部署gitlab和jenkins <a class="header-anchor" href="#docker-compose部署gitlab和jenkins" aria-label="Permalink to &quot;docker-compose部署gitlab和jenkins&quot;">​</a></h2><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>该示例采用<code>docker-compose</code>部署<code>gitlab</code>和<code>jenkins</code>；其中<code>jenkins</code>开启了特权模式，挂载了<code>docker.sock</code>文件用于和宿主机的<code>docker</code>服务端通信</p></div><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F07178;">version</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">3</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">services</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">gitlab</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">container_name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">gitlab</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">hostname</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">gitlab</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;"># 版本更新: https://docs.gitlab.com/ee/update/index.html#upgrade-paths </span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;"># 版本下载: https://packages.gitlab.com/app/gitlab/gitlab-ce/search</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;"># image: gitlab/gitlab-ce:latest</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">gitlab/gitlab-ce:14.6.1-ce.0</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">restart</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">unless-stopped</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">environment</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">TZ</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Asia/Shanghai</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">EXTERNAL_URL</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">http://192.168.10.11:8000</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">GITLAB_OMNIBUS_CONFIG</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">|</span></span>
<span class="line"><span style="color:#C3E88D;">        external_url &#39;http://192.168.10.11:8000&#39;</span></span>
<span class="line"><span style="color:#C3E88D;">        gitlab_rails[&#39;initial_root_password&#39;] = &#39;testfind&#39;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">8000:8000</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">8022:22</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">volumes</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">./gitlab/config:/etc/gitlab</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">./gitlab/data:/var/opt/gitlab</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">./gitlab/logs:/var/log/gitlab</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">/etc/localtime:/etc/localtime</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">logging</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">driver</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">json-file</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">options</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">max-size</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">100m</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">max-file</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">3</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">networks</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">devops</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">jenkins</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">container_name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">jenkins</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">hostname</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">jenkins</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;"># image: jenkins/jenkins:lts</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">jenkins/jenkins:2.453</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">restart</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">unless-stopped</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">privileged</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">user</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">environment</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">TZ</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Asia/Shanghai</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">JAVA_OPTS</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">-Duser.timezone=Asia/Shanghai</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">ports</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">8080:8080</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">volumes</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">./jenkins/data:/var/jenkins_home</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">./jenkins/docker:/root/.docker</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">/var/run/docker.sock:/var/run/docker.sock</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">/usr/bin/docker:/usr/bin/docker</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">/etc/localtime:/etc/localtime</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">logging</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">driver</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">json-file</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">options</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">max-size</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">100m</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#F07178;">max-file</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">3</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">networks</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">devops</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">networks</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">devops</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">driver</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">bridge</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#F07178;">ipam</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">config</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;"> </span><span style="color:#F07178;">subnet</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">172.80.0.0/16</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><h2 id="jenkins配置" tabindex="-1">jenkins配置 <a class="header-anchor" href="#jenkins配置" aria-label="Permalink to &quot;jenkins配置&quot;">​</a></h2><div class="tip custom-block"><p class="custom-block-title">TIP</p><p><code>jenkins</code>初始密码可以通过日志或者<code>/var/jenkins_home/secrets/initialAdminPassword</code>文件查看</p></div><h3 id="更新插件地址" tabindex="-1">更新插件地址 <a class="header-anchor" href="#更新插件地址" aria-label="Permalink to &quot;更新插件地址&quot;">​</a></h3><p>进入jenkins容器中执行</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">sed</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">-i</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">s#updates.jenkins.io/download/plugins#mirrors.tuna.tsinghua.edu.cn/jenkins/plugins#g</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">/var/jenkins_home/updates/default.json</span></span>
<span class="line"><span style="color:#FFCB6B;">sed</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">-i</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">s#www.google.com#www.baidu.com#g</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">/var/jenkins_home/updates/default.json</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>或者在当前目录下执行</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">sed</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">-i</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">s#updates.jenkins.io/download/plugins#mirrors.tuna.tsinghua.edu.cn/jenkins/plugins#g</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">jenkins/data/updates/default.json</span></span>
<span class="line"><span style="color:#FFCB6B;">sed</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">-i</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">s#www.google.com#www.baidu.com#g</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">jenkins/data/updates/default.json</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="下载插件" tabindex="-1">下载插件 <a class="header-anchor" href="#下载插件" aria-label="Permalink to &quot;下载插件&quot;">​</a></h3><ul><li><code>Localization: Chinese (Simplified)</code></li><li><code>Pipeline</code></li><li><code>Pipeline: GitHub Groovy Libraries</code></li><li><code>Pipeline: Stage View Plugin</code></li><li><code>Git</code></li><li><code>Git Parameter</code></li><li><code>Workspace Cleanup</code></li><li><code>SSH Agent</code></li><li><code>SSH Build Agents</code></li><li><code>Publish Over SSH</code></li></ul><h3 id="全局工具配置" tabindex="-1">全局工具配置 <a class="header-anchor" href="#全局工具配置" aria-label="Permalink to &quot;全局工具配置&quot;">​</a></h3><ul><li><code>JDK</code>安装: 指定<code>jdk</code>安装路径，指定别名<code>jdk8</code>供<code>pipeline</code>使用</li><li><code>Maven</code>安装: 指定<code>maven</code>安装路径，指定别名<code>mvn3</code>供<code>pipeline</code>使用，并配置<code>settings.xml</code></li></ul><h3 id="凭据管理" tabindex="-1">凭据管理 <a class="header-anchor" href="#凭据管理" aria-label="Permalink to &quot;凭据管理&quot;">​</a></h3><ul><li><code>git-user-pass</code>: git仓库登录凭证</li><li><code>harbor-user-pass</code>: harbor仓库登录凭证，或者执行之前手动登录一次镜像仓库</li></ul><h3 id="创建任务" tabindex="-1">创建任务 <a class="header-anchor" href="#创建任务" aria-label="Permalink to &quot;创建任务&quot;">​</a></h3><p>step01 添加参数</p><p>参数化构建过程 -&gt; 选项参数 -&gt; <code>branchName</code></p><p>step02 创建流水线脚本</p><p>⚡该<code>pipeline</code>模板只包括：清理工作空间、clone仓库、打包、构建镜像、推送镜像；请根据实际情况进行修改</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">pipeline</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#FFCB6B;">agent</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">any</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#FFCB6B;">environment</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">//</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">git仓库地址</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">gitUrl</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">http://192.168.10.11:8000/group01/demo-jenkins01.git</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">//</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">git仓库分支</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">branchName</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;\${</span><span style="color:#BABED8;">branchName</span><span style="color:#89DDFF;">}&quot;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">//</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">项目的相对路径</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">projPath</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">demo-hello</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">//</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">镜像名称</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">imageName</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">demo-hello</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">//</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">镜像tag</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">imageTag</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">=</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">sh</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">script:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">echo </span><span style="color:#89DDFF;">\`</span><span style="color:#FFCB6B;">date</span><span style="color:#C3E88D;"> +</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">%Y%m%d_%H%M</span><span style="color:#89DDFF;">&#39;\`&quot;</span><span style="color:#C3E88D;">,</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">returnStdout:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">true</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">.trim</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">//</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">镜像仓库地址</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">registryAddr</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">harbor.example.com</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">//</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">镜像仓库名称</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">registryName</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">common-test</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#BABED8;">    }</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#FFCB6B;">tools</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">//</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">需要先在全局工具配置中配置jdk和maven</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">jdk</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">jdk8</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">maven</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">mvn3</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">    }</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#FFCB6B;">stages</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">stage(</span><span style="color:#FFCB6B;">&#39;清理工作空间&#39;</span><span style="color:#BABED8;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#FFCB6B;">steps</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#BABED8;">                </span><span style="color:#82AAFF;">echo</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 开始清理工作空间</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">                </span><span style="color:#82AAFF;">cleanWs</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">            }</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">stage(</span><span style="color:#FFCB6B;">&#39;拉取代码&#39;</span><span style="color:#BABED8;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#FFCB6B;">steps</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#BABED8;">                </span><span style="color:#82AAFF;">echo</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 开始拉取代码</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">                </span><span style="color:#FFCB6B;">git</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">branch:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;\${</span><span style="color:#BABED8;">branchName</span><span style="color:#89DDFF;">}&quot;</span><span style="color:#C3E88D;">,</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">credentialsId:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">git-user-pass</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">,</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">url:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;\${</span><span style="color:#BABED8;">gitUrl</span><span style="color:#89DDFF;">}&quot;</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">        }</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">stage(</span><span style="color:#FFCB6B;">&#39;mvn打包&#39;</span><span style="color:#BABED8;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#FFCB6B;">steps</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#BABED8;">                </span><span style="color:#82AAFF;">echo</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 开始mvn打包</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">                </span><span style="color:#FFCB6B;">sh</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">cd \${projPath} &amp;&amp; mvn -Dmaven.test.skip=true clean package</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">        }</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">stage(</span><span style="color:#FFCB6B;">&#39;构建镜像&#39;</span><span style="color:#BABED8;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#FFCB6B;">steps</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#BABED8;">                </span><span style="color:#82AAFF;">echo</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 开始构建镜像</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">                </span><span style="color:#FFCB6B;">sh</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">cd \${projPath} &amp;&amp; docker build -t \${registryAddr}/\${registryName}/\${imageName}:\${imageTag} .</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">        }</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#FFCB6B;">stage(</span><span style="color:#FFCB6B;">&#39;推送镜像&#39;</span><span style="color:#BABED8;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#FFCB6B;">steps</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#BABED8;">                </span><span style="color:#FFCB6B;">//</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">需要先创建凭证,或者使用.docker/config.json都可以</span></span>
<span class="line"><span style="color:#BABED8;">                </span><span style="color:#FFCB6B;">withCredentials([usernamePassword(credentialsId:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">harbor-user-pass</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">,</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">usernameVariable:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">registryUser</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">,</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">passwordVariable:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">registryPass</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">,</span><span style="color:#BABED8;">)]) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">                    </span><span style="color:#82AAFF;">echo</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 登录镜像仓库</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">                    </span><span style="color:#FFCB6B;">sh</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">docker login -u </span><span style="color:#89DDFF;">\${</span><span style="color:#BABED8;">registryUser</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;"> -p </span><span style="color:#89DDFF;">\${</span><span style="color:#BABED8;">registryPass</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">\${</span><span style="color:#BABED8;">registryAddr</span><span style="color:#89DDFF;">}&quot;</span></span>
<span class="line"><span style="color:#BABED8;">                    </span><span style="color:#82AAFF;">echo</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 开始推送镜像</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">                    </span><span style="color:#FFCB6B;">sh</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">docker push \${registryAddr}/\${registryName}/\${imageName}:\${imageTag}</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">                </span><span style="color:#82AAFF;">echo</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 清理本地镜像</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">                </span><span style="color:#FFCB6B;">sh</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">docker rmi \${registryAddr}/\${registryName}/\${imageName}:\${imageTag}</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#BABED8;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">        }</span></span>
<span class="line"><span style="color:#BABED8;">    }</span></span>
<span class="line"><span style="color:#BABED8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h2 id="gitlab配置" tabindex="-1">gitlab配置 <a class="header-anchor" href="#gitlab配置" aria-label="Permalink to &quot;gitlab配置&quot;">​</a></h2><div class="tip custom-block"><p class="custom-block-title">TIP</p><p><code>gitlab</code>初始密码可以通过添加配置<code>gitlab_rails[&#39;initial_root_password&#39;] = &quot;password&quot;</code>或者查看配置文件<code>cat /etc/gitlab/initial_root_password | grep -i password</code></p></div><p>⚡如果忘记管理员密码可以使用下面的方式重置密码</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 先行进入命令行控制台</span></span>
<span class="line"><span style="color:#FFCB6B;">gitlab-rails</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">console</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">-e</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">production</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 获取id为1的用户,即获取root用户</span></span>
<span class="line"><span style="color:#BABED8;">user</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">User.where</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">id:1</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">.first</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 查看和确认下用户名</span></span>
<span class="line"><span style="color:#FFCB6B;">user.username</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 修改密码,注意密码长度要大于8位</span></span>
<span class="line"><span style="color:#FFCB6B;">user.password</span><span style="color:#BABED8;">=</span><span style="color:#FFCB6B;">&quot;xxxxxxxx&quot;</span></span>
<span class="line"><span style="color:#FFCB6B;">user.password_confirmation</span><span style="color:#BABED8;">=</span><span style="color:#FFCB6B;">&quot;xxxxxxxx&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 保存修改</span></span>
<span class="line"><span style="color:#FFCB6B;">user.save!</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div>`,26),e=[o];function t(r,c,D,i,y,B){return n(),a("div",null,e)}const E=s(p,[["render",t]]);export{b as __pageData,E as default};
